version: '3'
services:
  proxy:
    build:
      context: .
      dockerfile: ./docker/Dockerfile
    volumes:
      - store:/app/store
    environment:
      PORT: 3000
      ENDPOINT: http://proxy:3000
      ENABLE_STORE: "true"
      REPO_URI: "sqlite:///app/store/db"
      REPO_KEY: insecure
      LOG_LEVEL: DEBUG

  agent:
    image: ghcr.io/hyperledger/aries-cloudagent-python:py3.9-0.9.0-rc0
    volumes:
      - indy:/home/indy/.indy_client
    command: >
      start --label agent -it http 0.0.0.0 3000 -ot http -e http://agent:3000
      --no-ledger --admin 0.0.0.0 3001 --admin-insecure-mode
      --debug-connections --auto-accept-invites --auto-accept-requests
      --auto-ping-connection --log-level debug
      --wallet-type askar --wallet-name agent --wallet-key insecure --auto-provision
    ports:
      - 4001:3001

  setup:
    build:
      context: ./docker/setup
    environment:
      - WAIT_BEFORE_HOSTS=3
      - WAIT_HOSTS=proxy:3000,agent:3000
      - WAIT_HOSTS_TIMEOUT=30
      - WAIT_SLEEP_INTERVAL=1
      - WAIT_HOST_CONNECT_TIMEOUT=10
      - PROXY=http://proxy:3000
      - AGENT=http://agent:3001
      - MEDIATOR_INVITE=https://g6stx4sj2h.execute-api.us-east-1.amazonaws.com/Prod/message?oob=eyJAaWQiOiI5M2Q2ZGU4MS00MzVlLTRmMGQtYWZiMS0xZWVkNTY5YTM1NzIiLCJAdHlwZSI6Imh0dHBzOi8vZGlkY29tbS5vcmcvb3V0LW9mLWJhbmQvMS4xL2ludml0YXRpb24iLCJoYW5kc2hha2VfcHJvdG9jb2xzIjpbImh0dHBzOi8vZGlkY29tbS5vcmcvZGlkZXhjaGFuZ2UvMS4wIl0sInNlcnZpY2VzIjpbeyJpZCI6IiNpbmxpbmUiLCJ0eXBlIjoiZGlkLWNvbW11bmljYXRpb24iLCJyZWNpcGllbnRLZXlzIjpbImRpZDprZXk6ejZNa280WFl5c3l5dHZZM3hiaEY1UWE3WndGcXVHUldwUXp0Z0ZxQm40TnNnc05aIl0sInNlcnZpY2VFbmRwb2ludCI6Imh0dHBzOi8vZzZzdHg0c2oyaC5leGVjdXRlLWFwaS51cy1lYXN0LTEuYW1hem9uYXdzLmNvbS9Qcm9kL21lc3NhZ2UifSx7ImlkIjoiI2lubGluZSIsInR5cGUiOiJkaWQtY29tbXVuaWNhdGlvbiIsInJlY2lwaWVudEtleXMiOlsiZGlkOmtleTp6Nk1rbzRYWXlzeXl0dlkzeGJoRjVRYTdad0ZxdUdSV3BRenRnRnFCbjROc2dzTloiXSwic2VydmljZUVuZHBvaW50Ijoid3M6Ly9kZG0tMjAyNTM3MjYyMC51cy1lYXN0LTEuZWxiLmFtYXpvbmF3cy5jb20vd3MifV0sImFjY2VwdCI6WyJkaWRjb21tL2FpcDEiLCJkaWRjb21tL2FpcDI7ZW52PXJmYzE5Il0sImxhYmVsIjoiQ2xvdWQgTWVkaWF0b3IifQ==
    depends_on:
      - proxy
      - agent

volumes:
  store:
  indy:
